<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Language" content="en-us">
    <title>Example Web Editor</title>
    <link rel="stylesheet" type="text/css" href="xtext/2.25.0/xtext-ace.css"/>
    <link rel="stylesheet" type="text/css" href="./styles/style.css"/>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="webjars/requirejs/2.3.6/require.min.js"></script>
    <script src="./scripts/imports.js" defer></script>
    <script src="./scripts/generators/bdd.js" defer></script>
    <script src="./scripts/generators/blockGenerator.js" defer></script>
    <script src="./scripts/script.js" defer></script>
    <style>
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        font: 16px Helvetica, sans-serif;
      }

      a {
        color: #22a;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .editor-tab {
        height: 2rem;
      }

      .container {
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        box-sizing: border-box;
      }

      .header {
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        padding: 10px;
      }

      .content {
        display: flex;
        flex-direction: row;
        flex: 1;
        overflow: hidden;
      }

      .version-control-panel {
        width: 300px;
        background: white;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.3s ease;
      }

      .version-control-panel.collapsed {
        width: 40px;
      }

      .version-control-panel.collapsed .version-content,
      .version-control-panel.collapsed .version-header h3,
      .version-control-panel.collapsed .version-actions {
        display: none;
      }

      .editors-container {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .xtext-wrapper {
        flex: 1;
        height: 100%;
        box-sizing: border-box;
        border: 1px solid #aaa;
      }

      #blockly-editor {
        flex: 1;
        height: 100%;
        box-sizing: border-box;
      }

      .version-header {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .version-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .version-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }

      .version-actions {
        margin-bottom: 16px;
      }

      .versions-container {
        overflow-y: auto;
      }

      .version-item {
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 6px;
        margin-bottom: 8px;
        background: #f8f9fa;
        transition: all 0.2s ease;
      }

      .version-item:hover {
        border-color: #0066cc;
        background: #f0f7ff;
      }

      .version-item.selected {
        border-color: #0066cc;
        background: #e6f0ff;
      }

      .version-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .version-info {
        flex: 1;
      }

      .version-name {
        font-weight: 500;
        margin-bottom: 4px;
      }

      .version-timestamp {
        font-size: 12px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .editors-section {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      #console-section {
        display: flex;
        flex-direction: column;
        background-color: #1e1e1e;
        color: #fff;
        border-top: 2px solid #444;
        height: 300px;
        max-height: 30vh;
        overflow: hidden;
      }

      .console-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 15px;
        background-color: #333;
        border-bottom: 1px solid #444;
      }

      #console-output {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .primary-button {
        background: #0066cc;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .primary-button:hover {
        background: #0052a3;
      }

      .toggle-button {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .toggle-button:hover {
        background: #f0f0f0;
        border-radius: 4px;
      }

      .chevron {
        width: 20px;
        height: 20px;
        transition: transform 0.3s ease;
      }

      .collapsed .chevron {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Editor for BDD Scenarios</h1>
        <span class="file-name">
          <label for="fileName">File name</label>
          <input id="fileName" type="text" maxlength="35"/>
        </span>
      </div>
      <div class="content">
        <div class="version-control-panel">
          <div class="version-header">
            <h3>Version History</h3>
            <button class="toggle-button" onclick="toggleVersionPanel()">
              <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
          </div>
          <div class="version-content">
            <div class="version-actions">
              <button id="save-version" class="primary-button">
                <span class="save-icon"></span>
                Save Version
              </button>
            </div>
            <div id="versions-list" class="versions-container">
              <!-- Versions will be populated here -->
            </div>
          </div>
        </div>
        <div class="editors-container">
          <div class="editor-tab">
            <span id="entity-tab" data-editor-id="xtext-editor-entities" class="tab">Entities</span>
            <span id="scenario-tab" data-editor-id="xtext-editor-scenarios" class="tab">Scenarios</span>
            <span id="warning-message" style="color:red; visibility: hidden;">Entities should be defined first.</span>
          </div>
          <div class="editors-section">
            <div class="xtext-wrapper">
              <div id="xtext-editor-scenarios" class="xtext-editor" style="display: none" 
                data-editor-resource-id="multi-resource/scenarios.bdd" 
                data-editor-xtext-lang="bdd">
              </div>
              <div id="xtext-editor-entities" class="xtext-editor" style="display: block"
                data-editor-resource-id="multi-resource/widgets.bdd" 
                data-editor-xtext-lang="bdd">
              </div>
            </div>
            <div class="blockly" id="blockly-editor" style="display:block;"></div>
            <div class="blockly" id="blockly-editor2" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div>
        <button id="save-button" value="Save" title="Save">Save</button>
        <input id="file-input" type="file" style="display: none;"/>
        <button id="load-button" value="Load" title="Load">Load</button>
        <button id="get-ast">Get ast</button>
        <button id="save-scenario" onclick="saveScenario()">Save Scenario</button>
        <button id="save-entities" onclick="saveEntities()">Save Entities</button>
		<button id="run-scenario" onclick="runScenarioInteractive()">Run Scenario</button>
      </div>
      <div id="console-section">
        <div class="console-header">
          Console Output
          <button id="clear-console">Clear</button>
        </div>
        <div id="console-output">
          Starting scenario execution...
        </div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          initializeVersionControl();
      });

      function toggleVersionPanel() {
          const panel = document.querySelector('.version-control-panel');
          panel.classList.toggle('collapsed');
      }

      function initializeVersionControl() {
          document.getElementById('save-version').addEventListener('click', saveVersion);
          listVersions();
      }

      async function listVersions() {
          try {
              const response = await fetch('/list-versions');
              const versions = await response.json();
              
              const versionsContainer = document.getElementById('versions-list');
              versionsContainer.innerHTML = '';
              
              versions.forEach(version => {
                  const versionElement = createVersionElement(version);
                  versionsContainer.appendChild(versionElement);
              });
              
              appendToConsole("Versions loaded successfully.\n");
          } catch (error) {
              appendToConsole(`Error loading versions: ${error.message}\n`);
          }
      }

      function createVersionElement(version) {
		let dateString = version.metadata?.createdAt;
		if (!dateString) {
		    dateString = version.metadata?.timestamp;
		    if(dateString){
		        // Parse the custom timestamp string into a Date object
		        const year = parseInt(dateString.substring(0, 4));
		        const month = parseInt(dateString.substring(4, 6)) - 1; // Month is 0-indexed
		        const day = parseInt(dateString.substring(6, 8));
		        const hour = parseInt(dateString.substring(9, 11));
		        const minute = parseInt(dateString.substring(11, 13));
		        const second = parseInt(dateString.substring(13, 15));
		        dateString = new Date(year, month, day, hour, minute, second).toISOString();
		    } else {
		        dateString = version.lastModified;  // Fallback if both custom and createdAt are missing
		    }
		}
		const date = new Date(dateString); // Create date object once

		const fileName = version.metadata?.fileName || 'Unnamed';

          const versionDiv = document.createElement('div');
          versionDiv.className = 'version-item';
          versionDiv.dataset.version = version.filename;
          
          versionDiv.innerHTML = `
              <div class="version-item-header">
                  <div class="version-info">
                      <div class="version-name">${fileName}</div>
                      <div class="version-timestamp">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="12" cy="12" r="10"/>
                              <path d="M12 6v6l4 2"/>
                          </svg>
                          ${date.toLocaleString()}
                      </div>
                  </div>
                  <div class="version-actions">
                      <button onclick="revertToVersion('${version.filename}')">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                              <path d="M3 3v5h5"/>
                          </svg>
                          Revert
                      </button>
                  </div>
              </div>
          `;
          
          return versionDiv;
      }

      async function revertToVersion(versionFileName) {
          if (!versionFileName) {
              appendToConsole("No version selected for revert.\n");
              return;
          }

          try {
              const response = await fetch('/revert-version', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ versionFileName })
              });

              const result = await response.json();

              if (response.ok) {
                  appendToConsole(`Reverted to version: ${versionFileName}\n`);
                  
                  if (result.content) {
                      const editor = getCurrentAceEditor();
                      editor.setValue(result.content);
                      editor.clearSelection();
                  }
                  
                  document.querySelectorAll('.version-item').forEach(item => {
                      item.classList.remove('selected');
                      if (item.dataset.version === versionFileName) {
                          item.classList.add('selected');
                      }
                  });
                  
                  await listVersions();
              } else {
                  appendToConsole(`Failed to revert to version: ${result.message}\n`);
              }
          } catch (error) {
              appendToConsole(`Error reverting version: ${error.message}\n`);
          }
      }

      async function saveVersion() {
          const editor = getCurrentAceEditor();
          const content = editor.getValue();
          const metadata = {
              fileName: document.getElementById("fileName").value || 'Unnamed Scenario',
              timestamp: new Date().toISOString()
          };

          try {
              const response = await fetch('/save-scenario', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ content, metadata })
              });

              if (response.ok) {
                  const result = await response.json();
                  appendToConsole(`Version saved successfully: ${result.version}\n`);
                  await listVersions();
              } else {
                  const error = await response.text();
                  appendToConsole(`Failed to save version: ${error}\n`);
              }
          } catch (error) {
              appendToConsole(`Error: ${error.message}\n`);
          }
      }
	  
	  function saveScenario() {
	    const scenarioEditor = ace.edit("xtext-editor-scenarios");
	    const scenarioContent = scenarioEditor.getValue();

	    appendToConsole(`${scenarioContent}!\n`);

	    // Save the scenario content
	    fetch('/save-scenario', {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify({ content: scenarioContent })
	    })
	    .then(response => {
	      if (response.ok) {
	        appendToConsole('Scenario saved successfully!\n');
	      } else {
	        appendToConsole('Error saving scenario.\n');
	      }
	    })
	    .catch(error => {
	      appendToConsole('Error: An error occurred while saving the scenario.\n');
	    });
	  }

	  function saveEntities() {
	    const entitiesEditor = ace.edit("xtext-editor-entities");
	    const entitiesContent = entitiesEditor.getValue();
	    
	    appendToConsole(`Hi: ${entitiesContent}!\n`);

	    // Save the entities content
	    fetch('/save-entities', {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify({ content: entitiesContent })
	    })
	    .then(response => {
	      if (response.ok) {
	        appendToConsole('Entities saved successfully!\n');
	      } else {
	        appendToConsole('Error saving entities.\n');
	      }
	    })
	    .catch(error => {
	      appendToConsole('Error: An error occurred while saving the entities.\n');
	    });
	  }

    </script>
  </body>
</html>